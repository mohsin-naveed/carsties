<div class="find-car-container">
  <!-- Top search + sort bar, desktop style mirroring screenshot -->
  <div class="topbar">
    <div class="sort-wrap">
      <label for="sort-select" class="sort-label">Sort</label>
      <select id="sort-select" class="sort-select" [ngModel]="(sort$ | async)" (ngModelChange)="sort$.next($event)">
        <option *ngFor="let option of sortOptions" [value]="option.value">{{ option.label }}</option>
      </select>
    </div>
  </div>

  <div class="main-content">
    <!-- Filter Sidebar -->
    <aside class="filter-sidebar">
      <div class="filter-sidebar">
        <div class="filter-header">
          <h3 class="filter-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="filter-icon">
              <path d="M22 3H2L10 12.46V19L14 21V12.46L22 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            Filters
          </h3>
          <a href="#" class="clear-all" (click)="$event.preventDefault(); clearAll()">Clear all ({{ (activeFilterCount$ | async) ?? 0 }})</a>
        </div>
        <div class="filter-content">
          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(makeOpen$ | async) ? 'true' : 'false'" (click)="toggleMakeFacet()">
              <div class="section-title-container">
                <h4 class="section-title">Make <span class="count">({{ ((makes$ | async)?.length) ?? 0 }})</span></h4>
              </div>
              <span class="chevron">
                <mat-icon *ngIf="!(makeOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(makeOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(makeOpen$ | async)">
              <div class="options-container">
                <div class="filter-option" *ngFor="let m of (makes$ | async) ?? []">
                  <label class="option-label">
                    <input type="checkbox" class="filter-checkbox" [checked]="(selectedMakeIds$ | async)?.includes(m.id)" (change)="toggleMake(m.id)" />
                    <span class="custom-checkbox"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" class="check-icon"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                    <span class="option-text">{{ m.name }} <span class="count">({{ (makeCounts$ | async)?.get(m.id) ?? 0 }})</span></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(modelOpen$ | async) ? 'true' : 'false'" (click)="toggleModelFacet()">
              <div class="section-title-container"><h4 class="section-title">Model <span class="count">({{ ((filteredModels$ | async)?.length) ?? 0 }})</span></h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(modelOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(modelOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(modelOpen$ | async)">
              <div class="options-container">
                <div class="filter-option" *ngFor="let m of (filteredModels$ | async) ?? []">
                  <label class="option-label">
                    <input type="checkbox" class="filter-checkbox" [checked]="(selectedModelIds$ | async)?.includes(m.id)" (change)="toggleModel(m.id)" />
                    <span class="custom-checkbox"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" class="check-icon"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                    <span class="option-text">{{ m.name }} <span class="count">({{ (modelCounts$ | async)?.get(m.id) ?? 0 }})</span></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Range -->
          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(priceOpen$ | async) ? 'true' : 'false'" (click)="togglePriceFacet()">
              <div class="section-title-container"><h4 class="section-title">Price</h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(priceOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(priceOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(priceOpen$ | async)">
              <div class="range-row">
                <select class="range-select" [ngModel]="((priceMin$ | async) ?? '')" (ngModelChange)="onPriceMinChange($event)">
                  <option value="">Any</option>
                  <option *ngFor="let p of (fromPriceOptions$ | async) ?? []" [value]="p">£{{ p | number:'1.0-0' }} ({{ (priceCounts$ | async)?.get(p) ?? 0 }})</option>
                </select>
                <span class="range-sep">–</span>
                <select class="range-select" [ngModel]="(((priceMax$ | async) != null) ? ((priceMax$ | async) - (((priceStep$ | async) ?? 0) - 1)) : '')" (ngModelChange)="onPriceMaxChange($event)">
                  <option value="">Any</option>
                  <option *ngFor="let p of (toPriceOptions$ | async) ?? []" [value]="p">£{{ p | number:'1.0-0' }} ({{ (priceCounts$ | async)?.get(p) ?? 0 }})</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Year Range -->
          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(yearOpen$ | async) ? 'true' : 'false'" (click)="toggleYearFacet()">
              <div class="section-title-container"><h4 class="section-title">Year</h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(yearOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(yearOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(yearOpen$ | async)">
              <div class="range-row">
                <select class="range-select" [ngModel]="((yearMin$ | async) ?? '')" (ngModelChange)="onYearMinChange($event)">
                  <option value="">Any</option>
                  <option *ngFor="let y of (fromYearOptions$ | async) ?? []" [value]="y">{{ y }} ({{ (yearCounts$ | async)?.get(y) ?? 0 }})</option>
                </select>
                <span class="range-sep">–</span>
                <select class="range-select" [ngModel]="((yearMax$ | async) ?? '')" (ngModelChange)="onYearMaxChange($event)">
                  <option value="">Any</option>
                  <option *ngFor="let y of (toYearOptions$ | async) ?? []" [value]="y">{{ y }} ({{ (yearCounts$ | async)?.get(y) ?? 0 }})</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Mileage Range -->
          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(mileageOpen$ | async) ? 'true' : 'false'" (click)="toggleMileageFacet()">
              <div class="section-title-container"><h4 class="section-title">Mileage</h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(mileageOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(mileageOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(mileageOpen$ | async)">
              <div class="range-row">
                <select class="range-select" [ngModel]="((mileageMin$ | async) ?? '')" (ngModelChange)="onMileageMinChange($event)">
                  <option value="">Any</option>
                  <option *ngFor="let m of (fromMileageOptions$ | async) ?? []" [value]="m">{{ m | number:'1.0-0' }} miles ({{ (mileageCounts$ | async)?.get(m) ?? 0 }})</option>
                </select>
                <span class="range-sep">–</span>
                <select class="range-select" [ngModel]="(((mileageMax$ | async) != null) ? ((mileageMax$ | async) - (((mileageStep$ | async) ?? 0) - 1)) : '')" (ngModelChange)="onMileageMaxChange($event)">
                  <option value="">Any</option>
                  <option *ngFor="let m of (toMileageOptions$ | async) ?? []" [value]="m">{{ m | number:'1.0-0' }} miles ({{ (mileageCounts$ | async)?.get(m) ?? 0 }})</option>
                </select>
              </div>
            </div>
          </div>

          

          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(transOpen$ | async) ? 'true' : 'false'" (click)="toggleTransmissionFacet()">
              <div class="section-title-container"><h4 class="section-title">Gearbox <span class="count">({{ ((transmissions$ | async)?.length) ?? 0 }})</span></h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(transOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(transOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(transOpen$ | async)">
              <div class="options-container">
                <div class="filter-option" *ngFor="let t of (transmissions$ | async) ?? []">
                  <label class="option-label">
                    <input type="checkbox" class="filter-checkbox" [checked]="(selectedTransmissionIds$ | async)?.includes(t.id)" (change)="toggleTransmission(t.id)" />
                    <span class="custom-checkbox"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" class="check-icon"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                    <span class="option-text">{{ t.name }} <span class="count">({{ (transmissionCounts$ | async)?.get(t.id) ?? 0 }})</span></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(bodyOpen$ | async) ? 'true' : 'false'" (click)="toggleBodyFacet()">
              <div class="section-title-container"><h4 class="section-title">Body type <span class="count">({{ ((bodyTypes$ | async)?.length) ?? 0 }})</span></h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(bodyOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(bodyOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(bodyOpen$ | async)">
              <div class="options-container">
                <div class="filter-option" *ngFor="let b of (bodyTypes$ | async) ?? []">
                  <label class="option-label">
                    <input type="checkbox" class="filter-checkbox" [checked]="(selectedBodyTypeIds$ | async)?.includes(b.id)" (change)="toggleBodyType(b.id)" />
                    <span class="custom-checkbox"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" class="check-icon"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                    <span class="option-text">{{ b.name }} <span class="count">({{ (bodyCounts$ | async)?.get(b.id) ?? 0 }})</span></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="section-header" role="button" [attr.aria-expanded]="(fuelOpen$ | async) ? 'true' : 'false'" (click)="toggleFuelFacet()">
              <div class="section-title-container"><h4 class="section-title">Fuel type <span class="count">({{ ((fuelTypes$ | async)?.length) ?? 0 }})</span></h4></div>
              <span class="chevron">
                <mat-icon *ngIf="!(fuelOpen$ | async)">expand_more</mat-icon>
                <mat-icon *ngIf="(fuelOpen$ | async)">expand_less</mat-icon>
              </span>
            </div>
            <div class="section-content" [class.expanded]="(fuelOpen$ | async)">
              <div class="options-container">
                <div class="filter-option" *ngFor="let f of (fuelTypes$ | async) ?? []">
                  <label class="option-label">
                    <input type="checkbox" class="filter-checkbox" [checked]="(selectedFuelTypeIds$ | async)?.includes(f.id)" (change)="toggleFuelType(f.id)" />
                    <span class="custom-checkbox"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" class="check-icon"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                    <span class="option-text">{{ f.name }} <span class="count">({{ (fuelCounts$ | async)?.get(f.id) ?? 0 }})</span></span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <main class="car-results">
      <div class="results-header">
        We have found {{ (totalCount$ | async) ?? 0 }} vehicles
      </div>
      <div class="car-grid">
        <div class="car-card" *ngFor="let car of (listings$ | async) ?? []">
          <div class="card-media" [routerLink]="['/listings', car.id]" [queryParamsHandling]="'preserve'" title="View details">
            <img *ngIf="car.images?.length" [src]="car.images[0].thumbUrl || car.images[0].url" alt="car image" />
            <div *ngIf="!car.images?.length" class="media-placeholder"><mat-icon>directions_car</mat-icon></div>
            <div class="price-tag">£{{ car.price | number:'1.0-0' }}</div>
          </div>
          <div class="card-body">
            <div class="title">{{ car.makeName || car.makeId }} {{ car.modelName || car.modelId }}</div>
            <div class="subtitle">{{ car.variantName || car.derivativeName || '' }}</div>
            <div class="chips">
              <span class="chip">{{ car.year }}</span>
              <span class="chip">{{ car.mileage | number }} miles</span>
              <span class="chip" *ngIf="car.engineSnapshot as eng">{{ eng }}</span>
              <span class="chip" *ngIf="car.transmissionName as tn">{{ tn }}</span>
            </div>
            <div class="fuel-pill" *ngIf="car.fuelTypeName as f">{{ f }}</div>
            <div class="price-row">
              <div class="price">£{{ car.price | number:'1.0-0' }}</div>
              <div class="monthly">£{{ monthly(car.price) | number:'1.0-0' }} / monthly</div>
            </div>
            <div class="actions">
              <button class="btn btn-secondary" disabled>Reserve</button>
              <a class="btn btn-primary" [routerLink]="['/listings', car.id]" [queryParamsHandling]="'preserve'">View Details</a>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="!(loading$ | async) && ((totalCount$ | async) ?? 0) === 0" class="no-results">
        <div class="no-results-content">
          <h3>No cars found</h3>
          <p>Try adjusting your filters to see more results.</p>
        </div>
      </div>
      <!-- Simple Pagination Controls -->
      <div class="pagination" *ngIf="((totalPages$ | async) ?? 1) > 1">
        <button class="page-btn" [disabled]="((page$ | async) ?? 1) === 1 || (loading$ | async)" (click)="prevPage()">Previous</button>
        <span class="page-info">Page {{ (page$ | async) }} of {{ (totalPages$ | async) }}</span>
        <button class="page-btn" [disabled]="((page$ | async) ?? 1) === ((totalPages$ | async) ?? 1) || (loading$ | async)" (click)="nextPage()">Next</button>
      </div>
      <mat-progress-bar *ngIf="(loading$ | async)" mode="indeterminate"></mat-progress-bar>
      <!-- Active filters chips -->
      <div class="active-filters" *ngIf="(activeFilters$ | async)?.length">
        <span class="chip" *ngFor="let f of (activeFilters$ | async)">{{ f }}</span>
        <button class="clear-filters" (click)="clearAll()">Clear all</button>
      </div>
    </main>
  </div>
</div>
