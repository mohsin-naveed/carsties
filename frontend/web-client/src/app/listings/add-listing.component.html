<mat-card>
  <form [formGroup]="form" (ngSubmit)="submit()" class="form-grid" [attr.aria-busy]="saving">
  <mat-form-field appearance="outline">
    <mat-label>Year</mat-label>
    <mat-select formControlName="year">
      <mat-option *ngFor="let y of years" [value]="y">{{y}}</mat-option>
    </mat-select>
    <mat-error *ngIf="form.get('year')?.hasError('required') && form.get('year')?.touched">Year is required</mat-error>
  </mat-form-field>
  

  <mat-form-field appearance="outline"><mat-label>Make</mat-label>
    <mat-select formControlName="makeId">
      <mat-option *ngFor="let m of makes" [value]="m.id">{{m.name}}</mat-option>
    </mat-select>
    <mat-error *ngIf="form.get('makeId')?.hasError('required') && form.get('makeId')?.touched">Make is required</mat-error>
  </mat-form-field>

  <mat-form-field appearance="outline"><mat-label>Model</mat-label>
    <mat-select formControlName="modelId">
      <mat-option *ngFor="let m of models" [value]="m.id">{{m.name}}</mat-option>
    </mat-select>
    <mat-error *ngIf="form.get('modelId')?.hasError('required') && form.get('modelId')?.touched">Model is required</mat-error>
  </mat-form-field>

  <!-- Generation and Derivative hidden per requirements; set programmatically when a Variant is selected -->

  <mat-form-field appearance="outline"><mat-label>Variant</mat-label>
    <mat-select formControlName="variantId">
      <mat-option *ngFor="let v of variants" [value]="v.id">{{v.name}}</mat-option>
    </mat-select>
    <mat-error *ngIf="form.get('variantId')?.hasError('required') && form.get('variantId')?.touched">Variant is required</mat-error>
  </mat-form-field>

  <!-- Moved under Variant -->
  <mat-form-field appearance="outline">
    <mat-label>Mileage</mat-label>
    <input matInput type="number" formControlName="mileage" />
    <mat-error *ngIf="form.get('mileage')?.hasError('required') && form.get('mileage')?.touched">Mileage is required</mat-error>
    <mat-error *ngIf="form.get('mileage')?.hasError('min') && form.get('mileage')?.touched">Must be ≥ 0</mat-error>
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Price</mat-label>
    <input matInput type="number" formControlName="price" />
    <mat-error *ngIf="form.get('price')?.hasError('required') && form.get('price')?.touched">Price is required</mat-error>
    <mat-error *ngIf="form.get('price')?.hasError('min') && form.get('price')?.touched">Must be ≥ 0</mat-error>
  </mat-form-field>
  <mat-form-field appearance="outline">
    <mat-label>Description</mat-label>
    <textarea matInput rows="3" formControlName="description"></textarea>
  </mat-form-field>

  <mat-form-field appearance="outline"><mat-label>Transmission</mat-label>
    <mat-select formControlName="transmissionId">
      <mat-option *ngFor="let t of transmissions" [value]="t.id">{{t.name}}</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline"><mat-label>Fuel Type</mat-label>
    <mat-select formControlName="fuelTypeId">
      <mat-option *ngFor="let f of fuelTypes" [value]="f.id">{{f.name}}</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field appearance="outline"><mat-label>Body Type</mat-label>
    <mat-select formControlName="bodyTypeId">
      <mat-option *ngFor="let b of bodyTypes" [value]="b.id">{{b.name}}</mat-option>
    </mat-select>
    <mat-error *ngIf="form.get('bodyTypeId')?.hasError('required') && form.get('bodyTypeId')?.touched">Body Type is required</mat-error>
  </mat-form-field>

    <div class="actions">
      <button mat-raised-button color="primary" type="submit" [disabled]="saving || form.invalid">
        <mat-progress-spinner *ngIf="saving" mode="indeterminate" diameter="18" strokeWidth="3"></mat-progress-spinner>
        <span *ngIf="!saving">Add Listing</span>
      </button>
    </div>
  </form>
</mat-card>

<mat-card class="preview-card">
  <h3>Preview</h3>
  <div class="form-grid" style="gap:8px;">
    <div><strong>Year:</strong> {{ form.value.year || '-' }}</div>
    <div><strong>Make:</strong> {{ findById(makes, form.value.makeId)?.name || '-' }}</div>
    <div><strong>Model:</strong> {{ findById(models, form.value.modelId)?.name || '-' }}</div>
    <!-- Generation and Derivative hidden in form; still shown in preview if available -->
    <div><strong>Generation:</strong> {{ findById(generations, form.value.generationId)?.name || '-' }}</div>
    <div><strong>Derivative:</strong> {{ findById(derivatives, form.value.derivativeId)?.name || '-' }}</div>
    <div><strong>Variant:</strong> {{ findById(variants, form.value.variantId)?.name || '-' }}</div>
    <div><strong>Body Type:</strong> {{ findById(derivatives, form.value.derivativeId)?.bodyType || findById(bodyTypes, form.value.bodyTypeId)?.name || '-' }}</div>
    <div><strong>Transmission:</strong> {{ findById(derivatives, form.value.derivativeId)?.transmission || findById(transmissions, form.value.transmissionId)?.name || '-' }}</div>
    <div><strong>Fuel:</strong> {{ findById(derivatives, form.value.derivativeId)?.fuelType || findById(fuelTypes, form.value.fuelTypeId)?.name || '-' }}</div>
    <div><strong>Seats:</strong> {{ findById(derivatives, form.value.derivativeId)?.seats || '-' }}</div>
    <div><strong>Doors:</strong> {{ findById(derivatives, form.value.derivativeId)?.doors || '-' }}</div>
    <div><strong>Engine:</strong> {{ findById(derivatives, form.value.derivativeId)?.engine || '-' }}</div>
    <div><strong>Battery (kWh):</strong> {{ findById(derivatives, form.value.derivativeId)?.batteryCapacityKWh || '-' }}</div>
    <div style="grid-column:1/-1"><strong>Variant Features:</strong> {{ variantFeatures?.length || 0 }}</div>
  </div>
</mat-card>