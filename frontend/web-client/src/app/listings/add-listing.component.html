<form [formGroup]="form" (ngSubmit)="submit()" class="sell-form" [attr.aria-busy]="saving">
  <!-- Section 1: Car Information -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-icon mat-card-avatar color="primary">directions_car</mat-icon>
      <mat-card-title>Car Information</mat-card-title>
      <mat-card-subtitle>Tell buyers the key details</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="grid grid--car">
        <mat-form-field appearance="outline">
          <mat-label>Year</mat-label>
          <mat-select formControlName="year">
            <mat-option *ngFor="let y of years" [value]="y">{{y}}</mat-option>
          </mat-select>
          <button mat-icon-button matSuffix matTooltip="Year first registered" aria-label="Help about year">
            <mat-icon>calendar_today</mat-icon>
          </button>
          <mat-error *ngIf="form.get('year')?.hasError('required') && form.get('year')?.touched">Please choose the registration year</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Make</mat-label>
          <mat-select formControlName="makeId">
            <mat-option *ngFor="let m of (makes$ | async) ?? makes" [value]="m.id">{{m.name}}</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('makeId')?.hasError('required') && form.get('makeId')?.touched">Select the car make</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Model</mat-label>
          <mat-select formControlName="modelId">
            <mat-option *ngFor="let m of (models$ | async) ?? models" [value]="m.id">{{m.name}}</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('modelId')?.hasError('required') && form.get('modelId')?.touched">Select the model</mat-error>
        </mat-form-field>

        <mat-form-field *ngIf="form.value.modelId && ((((variants$ | async)?.length ?? (variants?.length ?? 0))) > 0)" appearance="outline">
          <mat-label>Variant</mat-label>
          <mat-select formControlName="variantId">
            <mat-option *ngFor="let v of (variants$ | async) ?? variants" [value]="v.id">{{v.name}}</mat-option>
          </mat-select>
          <mat-hint align="end">
            Can't find a matching variant?
            <button type="button" class="link-button" (click)="onSkip()">Skip</button>
          </mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Mileage</mat-label>
          <input matInput type="number" formControlName="mileage" aria-label="Mileage" #mileageInput />
          <button mat-icon-button matSuffix matTooltip="Enter the current odometer reading">
            <mat-icon>speed</mat-icon>
          </button>
          <mat-error *ngIf="form.get('mileage')?.hasError('required') && form.get('mileage')?.touched">Please enter the mileage</mat-error>
          <mat-error *ngIf="form.get('mileage')?.hasError('min') && form.get('mileage')?.touched">Mileage must be greater than zero</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Price</mat-label>
          <input matInput type="number" formControlName="price" aria-label="Price" />
          <button mat-icon-button matSuffix matTooltip="Set a competitive price">
            <mat-icon>attach_money</mat-icon>
          </button>
          <mat-error *ngIf="form.get('price')?.hasError('required') && form.get('price')?.touched">Please enter the car price</mat-error>
          <mat-error *ngIf="form.get('price')?.hasError('min') && form.get('price')?.touched">Price must be greater than zero</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Body Color</mat-label>
          <mat-select formControlName="bodyColor">
            <mat-option *ngFor="let c of bodyColors" [value]="c.name">
              <span class="color-dot" [style.backgroundColor]="c.hex"></span>
              {{c.name}}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="grid-col-span-2" appearance="outline">
          <mat-label>Description</mat-label>
          <textarea matInput rows="3" formControlName="description" aria-label="Description" matTooltip="Add highlights like condition, service history, extras"></textarea>
        </mat-form-field>

        <ng-container *ngIf="skipVariant || form.value.variantId || (form.value.modelId && ((((variants$ | async)?.length ?? (variants?.length ?? 0))) === 0))">
        <h4 class="subheading">Additional Information!</h4>
        <div class="helper" *ngIf="skipVariant && !form.value.variantId">You chose to skip variant — fill in the details below.</div>

        <mat-form-field appearance="outline">
          <mat-label>Transmission</mat-label>
          <mat-select formControlName="transmissionId" [disabled]="!(skipVariant || form.value.modelId || form.value.variantId)">
            <mat-option *ngFor="let t of (transmissions$ | async) ?? transmissions" [value]="t.id">{{t.name}}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Fuel Type</mat-label>
          <mat-select formControlName="fuelTypeId" [disabled]="!(skipVariant || form.value.modelId || form.value.variantId)">
            <mat-option *ngFor="let f of (fuelTypes$ | async) ?? fuelTypes" [value]="f.id">{{f.name}}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Body Type</mat-label>
          <mat-select formControlName="bodyTypeId" [disabled]="!(skipVariant || form.value.modelId || form.value.variantId)">
            <mat-option *ngFor="let b of (bodyTypes$ | async) ?? bodyTypes" [value]="b.id">{{b.name}}</mat-option>
          </mat-select>
          <mat-error *ngIf="form.get('bodyTypeId')?.hasError('required') && form.get('bodyTypeId')?.touched">Please choose a body type</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Engine Size (CC)</mat-label>
          <input matInput type="number" formControlName="engineSizeCC" aria-label="Engine Size CC" />
          <button mat-icon-button matSuffix matTooltip="Engine displacement in cubic centimeters">
            <mat-icon>build</mat-icon>
          </button>
        </mat-form-field>
      </ng-container>

      <div class="features" *ngIf="skipVariant || form.value.variantId || (form.value.modelId && ((((variants$ | async)?.length ?? (variants?.length ?? 0))) === 0))">
        <div class="features__title">Features</div>
        <div class="features__grid">
          <!-- Selected features first -->
          <ng-container *ngFor="let f of features">
            <ng-container *ngIf="selectedFeatureIds.has(f.id)">
              <mat-checkbox color="primary" [checked]="true" [disabled]="!(skipVariant || form.value.modelId || form.value.variantId)" (change)="toggleFeature(f.id, $event.checked)">{{f.name}}</mat-checkbox>
            </ng-container>
          </ng-container>
          <!-- Remaining features -->
          <ng-container *ngFor="let f of features">
            <ng-container *ngIf="!selectedFeatureIds.has(f.id)">
              <mat-checkbox color="primary" [checked]="false" [disabled]="!(skipVariant || form.value.modelId || form.value.variantId)" (change)="toggleFeature(f.id, $event.checked)">{{f.name}}</mat-checkbox>
            </ng-container>
          </ng-container>
        </div>
      </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-divider></mat-divider>

  <!-- Section 2: Upload Media -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-icon mat-card-avatar color="primary">photo_library</mat-icon>
      <mat-card-title>Upload Media</mat-card-title>
      <mat-card-subtitle>High‑quality photos sell faster</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="upload">
        <div class="upload__drop" [class.upload__drop--dragging]="dragging"
             (click)="fileInput.click()" (keydown.enter)="fileInput.click()" tabindex="0" role="button"
             aria-label="Upload images" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
          <mat-icon>cloud_upload</mat-icon>
          <div>Drag & drop images here or <span class="u-link">browse</span></div>
          <div class="upload__hint" matTooltip="JPG, PNG, WEBP up to 5MB. Aim for 6–10 photos.">JPG, PNG, WEBP • Max 5MB each</div>
        </div>
        <input #fileInput type="file" class="visually-hidden" multiple accept="image/*" (change)="onFilesSelected($event)" />

        <div class="upload__meta">Selected: {{ selectedFiles.length }} file(s)</div>

        <div class="upload__grid">
          <div class="upload__item" *ngFor="let p of previews; let i = index">
            <img [src]="p" alt="preview image" />
            <div class="upload__badge" *ngIf="i === 0">Cover</div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-divider></mat-divider>

  <!-- Section 3: Contact Information (UI-only) -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-icon mat-card-avatar color="primary">person</mat-icon>
      <mat-card-title>Contact Information</mat-card-title>
      <mat-card-subtitle>Your details are only shared with interested buyers</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="grid grid--contact">
        <mat-form-field appearance="outline">
          <mat-label>Name</mat-label>
          <input matInput formControlName="contactName" aria-label="Name" placeholder="Your full name" />
          <mat-hint>Shown to buyers when they message you</mat-hint>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Phone</mat-label>
          <input matInput type="tel" formControlName="contactPhone" aria-label="Phone" placeholder="e.g. 07123 456789" />
          <mat-hint>Keep your phone on for quick responses</mat-hint>
        </mat-form-field>
        <mat-form-field class="grid-col-span-2" appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="contactEmail" aria-label="Email" placeholder="you@example.com" />
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-divider></mat-divider>

  <!-- Section 4: Location -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-icon mat-card-avatar color="primary">place</mat-icon>
      <mat-card-title>Location</mat-card-title>
      <mat-card-subtitle>City and Area help buyers find your car</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="grid grid--location">
        <mat-form-field appearance="outline">
          <mat-label>City</mat-label>
          <input type="text" matInput [matAutocomplete]="cityAuto" formControlName="citySearch" placeholder="Start typing city name" />
          <mat-autocomplete #cityAuto="matAutocomplete" (optionSelected)="form.patchValue({ cityId: $event.option.value })">
            <mat-option *ngFor="let c of (cities$ | async) ?? cities" [value]="c.id">{{c.name}}<span class="muted"> — {{c.provinceName}}</span></mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Area</mat-label>
          <input type="text" matInput [matAutocomplete]="areaAuto" formControlName="areaSearch" placeholder="Type area (optional)" />
          <mat-autocomplete #areaAuto="matAutocomplete" (optionSelected)="form.patchValue({ areaId: $event.option.value })">
            <mat-option *ngFor="let a of (areas$ | async) ?? areas" [value]="a.id">{{a.name}}<span class="muted"> — {{a.cityName}}</span></mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="actions">
    <button mat-raised-button color="primary" type="submit" [disabled]="saving || form.invalid">
      <mat-progress-spinner *ngIf="saving" mode="indeterminate" diameter="18" strokeWidth="3"></mat-progress-spinner>
      <span *ngIf="!saving">Add Listing</span>
    </button>
  </div>
</form>

