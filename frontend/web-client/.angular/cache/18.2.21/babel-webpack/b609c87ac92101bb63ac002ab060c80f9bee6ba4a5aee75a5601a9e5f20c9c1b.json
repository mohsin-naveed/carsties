{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component, computed, effect, inject, signal } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { ListingsApiService } from '../listings/listings-api.service';\nimport { forkJoin } from 'rxjs';\nimport { MatFormFieldModule } from '@angular/material/form-field';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatIconModule } from '@angular/material/icon';\nimport { MatCardModule } from '@angular/material/card';\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { MatProgressBarModule } from '@angular/material/progress-bar';\nimport { RouterModule } from '@angular/router';\nlet SearchComponent = class SearchComponent {\n  api = inject(ListingsApiService);\n  route = inject(ActivatedRoute);\n  router = inject(Router);\n  // Filters\n  makes = signal([]);\n  models = signal([]);\n  variants = signal([]);\n  transmissions = signal([]);\n  bodyTypes = signal([]);\n  fuelTypes = signal([]);\n  selectedMakeId = signal(null);\n  selectedModelId = signal(null);\n  selectedVariantId = signal(null);\n  selectedTransmissionId = signal(null);\n  selectedBodyTypeId = signal(null);\n  selectedFuelTypeId = signal(null);\n  // Listings\n  allListings = signal([]);\n  loading = signal(true);\n  serverMode = signal(false);\n  // Sorting\n  selectedSort = signal('price-asc');\n  sortOptions = [{\n    label: 'Price: Low to High',\n    value: 'price-asc'\n  }, {\n    label: 'Price: High to Low',\n    value: 'price-desc'\n  }, {\n    label: 'Year: Newest',\n    value: 'year-desc'\n  }, {\n    label: 'Year: Oldest',\n    value: 'year-asc'\n  }];\n  anyFilterActive = computed(() => !!(this.selectedMakeId() || this.selectedModelId() || this.selectedVariantId() || this.selectedTransmissionId() || this.selectedBodyTypeId() || this.selectedFuelTypeId()));\n  filteredListings = computed(() => {\n    const makeId = this.selectedMakeId();\n    const modelId = this.selectedModelId();\n    const variantId = this.selectedVariantId();\n    const transmissionId = this.selectedTransmissionId();\n    const bodyTypeId = this.selectedBodyTypeId();\n    const fuelTypeId = this.selectedFuelTypeId();\n    // If using server-side filtering, results are already filtered\n    let items = this.allListings();\n    if (!this.serverMode()) items = items.filter(l => (makeId ? l.makeId === makeId : true) && (modelId ? l.modelId === modelId : true) && (variantId ? l.variantId === variantId : true) && (transmissionId ? l.transmissionId === transmissionId : true) && (bodyTypeId ? l.bodyTypeId === bodyTypeId : true) && (fuelTypeId ? l.fuelTypeId === fuelTypeId : true));\n    const sort = this.selectedSort();\n    const byPrice = (a, b) => (a.price ?? 0) - (b.price ?? 0);\n    const byYear = (a, b) => (a.year ?? 0) - (b.year ?? 0);\n    switch (sort) {\n      case 'price-asc':\n        items = [...items].sort(byPrice);\n        break;\n      case 'price-desc':\n        items = [...items].sort((a, b) => byPrice(b, a));\n        break;\n      case 'year-asc':\n        items = [...items].sort(byYear);\n        break;\n      case 'year-desc':\n        items = [...items].sort((a, b) => byYear(b, a));\n        break;\n    }\n    return items;\n  });\n  constructor() {\n    // Load initial data\n    this.api.getListings().subscribe({\n      next: xs => {\n        this.allListings.set(xs);\n        this.loading.set(false);\n      },\n      error: _ => {\n        this.loading.set(false);\n      }\n    });\n    this.api.getMakes().subscribe(xs => this.makes.set(xs));\n    this.api.getOptions().subscribe(opts => {\n      this.transmissions.set(opts.transmissions);\n      this.bodyTypes.set(opts.bodyTypes);\n      this.fuelTypes.set(opts.fuelTypes);\n    });\n    // React to Make selection -> load Models\n    effect(() => {\n      const mk = this.selectedMakeId();\n      this.selectedModelId.set(null);\n      this.models.set([]);\n      this.variants.set([]);\n      this.selectedVariantId.set(null);\n      if (mk) {\n        this.api.getModels(mk).subscribe(xs => this.models.set(xs));\n      }\n    });\n    // React to Model selection -> load Variants across generations\n    effect(() => {\n      const mdl = this.selectedModelId();\n      this.variants.set([]);\n      this.selectedVariantId.set(null);\n      if (mdl) {\n        this.api.getGenerations(mdl).subscribe(gens => {\n          if (!gens || gens.length === 0) {\n            this.variants.set([]);\n            return;\n          }\n          const obs = gens.map(g => this.api.getVariantsByGeneration(g.id));\n          // Combine all variants from all generations\n          forkJoin(obs).subscribe({\n            next: results => {\n              this.variants.set(results.flat());\n            },\n            error: _ => {\n              this.variants.set([]);\n            }\n          });\n        });\n      }\n    });\n    // Read initial filters from URL\n    this.route.queryParamMap.subscribe(q => {\n      const getNum = key => {\n        const v = q.get(key);\n        return v ? Number(v) : null;\n      };\n      this.selectedMakeId.set(getNum('make'));\n      this.selectedModelId.set(getNum('model'));\n      this.selectedVariantId.set(getNum('variant'));\n      this.selectedTransmissionId.set(getNum('trans'));\n      this.selectedBodyTypeId.set(getNum('body'));\n      this.selectedFuelTypeId.set(getNum('fuel'));\n    });\n    // Persist filters to URL when they change\n    effect(() => {\n      const qp = {\n        make: this.selectedMakeId(),\n        model: this.selectedModelId(),\n        variant: this.selectedVariantId(),\n        trans: this.selectedTransmissionId(),\n        body: this.selectedBodyTypeId(),\n        fuel: this.selectedFuelTypeId()\n      };\n      // Remove nulls for cleaner URLs\n      Object.keys(qp).forEach(k => qp[k] === null && delete qp[k]);\n      this.router.navigate([], {\n        queryParams: qp,\n        queryParamsHandling: 'merge'\n      });\n    });\n    // Switch to server-side filtering when any filter is active\n    effect(() => {\n      const params = {\n        makeId: this.selectedMakeId() ?? undefined,\n        modelId: this.selectedModelId() ?? undefined,\n        variantId: this.selectedVariantId() ?? undefined,\n        transmissionId: this.selectedTransmissionId() ?? undefined,\n        bodyTypeId: this.selectedBodyTypeId() ?? undefined,\n        fuelTypeId: this.selectedFuelTypeId() ?? undefined\n      };\n      const active = this.anyFilterActive();\n      this.serverMode.set(active);\n      this.loading.set(true);\n      this.api.getListings(active ? params : undefined).subscribe({\n        next: xs => {\n          this.allListings.set(xs);\n          this.loading.set(false);\n        },\n        error: _ => {\n          this.loading.set(false);\n        }\n      });\n    });\n  }\n};\nSearchComponent = __decorate([Component({\n  selector: 'app-search',\n  standalone: true,\n  imports: [CommonModule, MatFormFieldModule, MatSelectModule, MatIconModule, MatCardModule, MatProgressBarModule, RouterModule],\n  templateUrl: './search.component.html',\n  styleUrls: ['./search.component.scss']\n}), __metadata(\"design:paramtypes\", [])], SearchComponent);\nexport { SearchComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}