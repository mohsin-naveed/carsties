{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component, inject } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { ReactiveFormsModule, FormBuilder, Validators } from '@angular/forms';\nimport { MatFormFieldModule } from '@angular/material/form-field';\nimport { MatInputModule } from '@angular/material/input';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatButtonModule } from '@angular/material/button';\nimport { MatOptionModule } from '@angular/material/core';\nimport { ObserversModule } from '@angular/cdk/observers';\nimport { ListingsApiService } from './listings-api.service';\nlet AddListingComponent = class AddListingComponent {\n  fb = inject(FormBuilder);\n  api = inject(ListingsApiService);\n  form = this.fb.group({\n    title: ['', Validators.required],\n    description: [''],\n    year: [2022, [Validators.required, Validators.min(1900)]],\n    mileage: [0, [Validators.required, Validators.min(0)]],\n    price: [0, [Validators.required, Validators.min(0)]],\n    color: [''],\n    makeId: [null, Validators.required],\n    modelId: [null, Validators.required],\n    generationId: [null, Validators.required],\n    derivativeId: [null, Validators.required],\n    variantId: [null, Validators.required],\n    transmissionId: [null],\n    fuelTypeId: [null],\n    bodyTypeId: [null, Validators.required]\n  });\n  makes = [];\n  models = [];\n  generations = [];\n  derivatives = [];\n  variants = [];\n  transmissions = [];\n  fuelTypes = [];\n  bodyTypes = [];\n  variantFeatures = [];\n  constructor() {\n    this.api.getMakes().subscribe(m => this.makes = m);\n    this.api.getOptions().subscribe(o => {\n      this.transmissions = o.transmissions;\n      this.fuelTypes = o.fuelTypes;\n      this.bodyTypes = o.bodyTypes;\n    });\n    this.form.get('makeId').valueChanges.subscribe(val => {\n      this.models = [];\n      this.form.patchValue({\n        modelId: null,\n        generationId: null,\n        derivativeId: null,\n        variantId: null\n      }, {\n        emitEvent: false\n      });\n      if (val) this.api.getModels(val).subscribe(models => this.models = models);\n    });\n    this.form.get('modelId').valueChanges.subscribe(val => {\n      this.generations = [];\n      this.form.patchValue({\n        generationId: null,\n        derivativeId: null,\n        variantId: null\n      }, {\n        emitEvent: false\n      });\n      if (val) this.api.getGenerations(val).subscribe(gens => this.generations = gens);\n      if (val) this.api.getDerivatives(val).subscribe(ders => this.derivatives = ders);\n    });\n    this.form.get('derivativeId').valueChanges.subscribe(val => {\n      this.variants = [];\n      this.form.patchValue({\n        variantId: null\n      }, {\n        emitEvent: false\n      });\n      if (val) {\n        const der = this.derivatives.find(d => d.id === val);\n        const genId = der?.generationId;\n        if (genId) this.api.getVariantsByGeneration(genId).subscribe(vars => this.variants = vars);\n      }\n    });\n    this.form.get('variantId').valueChanges.subscribe(variantId => {\n      this.variantFeatures = [];\n      if (variantId) this.api.getVariantFeatures(variantId).subscribe(vf => this.variantFeatures = vf);\n    });\n  }\n  submit() {\n    if (this.form.invalid) return;\n    const raw = this.form.value;\n    const dto = {\n      title: raw.title,\n      description: raw.description ?? undefined,\n      year: raw.year,\n      mileage: raw.mileage,\n      price: raw.price,\n      color: raw.color ?? undefined,\n      makeId: raw.makeId,\n      modelId: raw.modelId,\n      generationId: raw.generationId,\n      derivativeId: raw.derivativeId,\n      variantId: raw.variantId,\n      transmissionId: raw.transmissionId ?? undefined,\n      fuelTypeId: raw.fuelTypeId ?? undefined,\n      bodyTypeId: raw.bodyTypeId,\n      // snapshots\n      makeName: this.makes.find(x => x.id === raw.makeId)?.name,\n      modelName: this.models.find(x => x.id === raw.modelId)?.name,\n      generationName: this.generations.find(x => x.id === raw.generationId)?.name,\n      derivativeName: this.derivatives.find(x => x.id === raw.derivativeId)?.name,\n      variantName: this.variants.find(x => x.id === raw.variantId)?.name,\n      bodyTypeName: this.derivatives.find(x => x.id === raw.derivativeId)?.bodyType ?? this.bodyTypes.find(x => x.id === raw.bodyTypeId)?.name,\n      transmissionName: this.derivatives.find(x => x.id === raw.derivativeId)?.transmission ?? this.transmissions.find(x => x.id === raw.transmissionId)?.name,\n      fuelTypeName: this.derivatives.find(x => x.id === raw.derivativeId)?.fuelType ?? this.fuelTypes.find(x => x.id === raw.fuelTypeId)?.name,\n      seatsSnapshot: this.derivatives.find(x => x.id === raw.derivativeId)?.seats,\n      doorsSnapshot: this.derivatives.find(x => x.id === raw.derivativeId)?.doors,\n      engineSnapshot: this.derivatives.find(x => x.id === raw.derivativeId)?.engine,\n      batteryCapacityKWhSnapshot: this.derivatives.find(x => x.id === raw.derivativeId)?.batteryCapacityKWh,\n      variantFeaturesJson: this.variantFeatures.length ? JSON.stringify(this.variantFeatures) : undefined\n    };\n    this.api.createListing(dto).subscribe({\n      next: () => alert('Listing created'),\n      error: e => alert('Failed: ' + e)\n    });\n  }\n};\nAddListingComponent = __decorate([Component({\n  selector: 'app-add-listing',\n  standalone: true,\n  imports: [CommonModule, ReactiveFormsModule, ObserversModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatOptionModule, MatButtonModule],\n  templateUrl: './add-listing.component.html'\n}), __metadata(\"design:paramtypes\", [])], AddListingComponent);\nexport { AddListingComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}