{"ast":null,"code":"var __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component, inject } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { ReactiveFormsModule, FormBuilder, Validators } from '@angular/forms';\nimport { MatFormFieldModule } from '@angular/material/form-field';\nimport { MatInputModule } from '@angular/material/input';\nimport { MatSelectModule } from '@angular/material/select';\nimport { MatButtonModule } from '@angular/material/button';\nimport { MatOptionModule } from '@angular/material/core';\nimport { MatCardModule } from '@angular/material/card';\nimport { MatCheckboxModule } from '@angular/material/checkbox';\nimport { MatIconModule } from '@angular/material/icon';\nimport { MatTooltipModule } from '@angular/material/tooltip';\nimport { MatDividerModule } from '@angular/material/divider';\nimport { ObserversModule } from '@angular/cdk/observers';\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\nimport { ListingsApiService } from './listings-api.service';\nimport { BehaviorSubject, combineLatest, forkJoin } from 'rxjs';\nimport { map, shareReplay, distinctUntilChanged, startWith, finalize } from 'rxjs/operators';\nimport { takeUntilDestroyed } from '@angular/core/rxjs-interop';\nimport { NotificationService } from '../core/notification.service';\nimport { DestroyRef } from '@angular/core';\nlet AddListingComponent = class AddListingComponent {\n  fb = inject(FormBuilder);\n  api = inject(ListingsApiService);\n  notify = inject(NotificationService);\n  destroyRef = inject(DestroyRef);\n  saving = false;\n  years = [];\n  form = this.fb.group({\n    description: [''],\n    year: [null, [Validators.required, Validators.min(1900)]],\n    mileage: [0, [Validators.required, Validators.min(0)]],\n    price: [0, [Validators.required, Validators.min(0)]],\n    makeId: [null, Validators.required],\n    modelId: [null, Validators.required],\n    // Hidden fields, set programmatically based on selected variant\n    generationId: [null],\n    derivativeId: [null],\n    // Variant is now optional per requirements\n    variantId: [null],\n    transmissionId: [null],\n    fuelTypeId: [null],\n    bodyTypeId: [null, Validators.required]\n  });\n  // State subjects (mirroring web-admin style)\n  makes$ = new BehaviorSubject([]);\n  models$ = new BehaviorSubject([]);\n  generations$ = new BehaviorSubject([]);\n  derivatives$ = new BehaviorSubject([]);\n  variants$ = new BehaviorSubject([]);\n  transmissions$ = new BehaviorSubject([]);\n  fuelTypes$ = new BehaviorSubject([]);\n  bodyTypes$ = new BehaviorSubject([]);\n  features$ = new BehaviorSubject([]);\n  variantFeatures$ = new BehaviorSubject([]);\n  // Backing arrays for existing template usage\n  makes = [];\n  models = [];\n  generations = [];\n  derivatives = [];\n  variants = [];\n  transmissions = [];\n  fuelTypes = [];\n  bodyTypes = [];\n  variantFeatures = [];\n  features = [];\n  selectedFeatureIds = new Set();\n  selectedFiles = [];\n  previews = [];\n  dragging = false;\n  skipVariant = false;\n  constructor() {\n    // Build years dropdown (descending from current year to 1900)\n    const current = new Date().getFullYear();\n    for (let y = current; y >= 1900; y--) this.years.push(y);\n    // Load static reference data\n    // Load static reference data\n    this.api.getMakes().pipe(takeUntilDestroyed(this.destroyRef)).subscribe(m => {\n      this.makes = m;\n      this.makes$.next(m);\n    });\n    this.api.getOptions().pipe(takeUntilDestroyed(this.destroyRef)).subscribe(o => {\n      this.transmissions = o.transmissions;\n      this.fuelTypes = o.fuelTypes;\n      this.bodyTypes = o.bodyTypes;\n      this.transmissions$.next(o.transmissions);\n      this.fuelTypes$.next(o.fuelTypes);\n      this.bodyTypes$.next(o.bodyTypes);\n    });\n    this.api.getFeatures().pipe(takeUntilDestroyed(this.destroyRef)).subscribe(f => {\n      this.features = f;\n      this.features$.next(f);\n    });\n    // When Make changes: load models under make, aggregate derivatives/generations for its models, then refresh variants\n    this.form.get('makeId').valueChanges.pipe(distinctUntilChanged(), takeUntilDestroyed(this.destroyRef)).subscribe(makeId => {\n      this.models = [];\n      this.generations = [];\n      this.derivatives = [];\n      this.variants = [];\n      this.variantFeatures = [];\n      this.form.patchValue({\n        modelId: null,\n        generationId: null,\n        derivativeId: null,\n        variantId: null\n      }, {\n        emitEvent: false\n      });\n      if (!makeId) {\n        this.models$.next([]);\n        this.generations$.next([]);\n        this.derivatives$.next([]);\n        this.refreshVariants();\n        return;\n      }\n      this.api.getModels(makeId).pipe(takeUntilDestroyed(this.destroyRef)).subscribe(models => {\n        this.models = models;\n        this.models$.next(models);\n        if (models.length === 0) {\n          this.refreshVariants();\n          return;\n        }\n        const genReqs = models.map(m => this.api.getGenerations(m.id));\n        const derReqs = models.map(m => this.api.getDerivatives(m.id));\n        forkJoin({\n          gens: forkJoin(genReqs).pipe(map(groups => groups.flat())),\n          ders: forkJoin(derReqs).pipe(map(groups => groups.flat()))\n        }).pipe(takeUntilDestroyed(this.destroyRef)).subscribe(({\n          gens,\n          ders\n        }) => {\n          this.generations = gens;\n          this.derivatives = ders;\n          this.generations$.next(gens);\n          this.derivatives$.next(ders);\n          this.refreshVariants();\n        });\n      });\n    });\n    // When Model changes: refresh variants (derivatives/generations already loaded for make)\n    this.form.get('modelId').valueChanges.pipe(distinctUntilChanged(), takeUntilDestroyed(this.destroyRef)).subscribe(() => {\n      this.variants = [];\n      this.form.patchValue({\n        variantId: null\n      }, {\n        emitEvent: false\n      });\n      this.refreshVariants();\n    });\n    // When Year changes: recompute variants\n    this.form.get('year').valueChanges.pipe(distinctUntilChanged(), takeUntilDestroyed(this.destroyRef)).subscribe(() => {\n      this.variants = [];\n      this.form.patchValue({\n        variantId: null\n      }, {\n        emitEvent: false\n      });\n      this.refreshVariants();\n    });\n    // On Variant selection: derive generation/derivative and load features\n    this.form.get('variantId').valueChanges.pipe(distinctUntilChanged(), takeUntilDestroyed(this.destroyRef)).subscribe(variantId => {\n      this.variantFeatures = [];\n      this.variantFeatures$.next([]);\n      this.selectedFeatureIds.clear();\n      const variant = this.variants.find(v => v.id === variantId);\n      const der = this.derivatives.find(d => d.id === variant?.derivativeId);\n      const genId = der?.generationId ?? null;\n      this.form.patchValue({\n        derivativeId: der?.id ?? null,\n        generationId: genId\n      }, {\n        emitEvent: false\n      });\n      if (variantId) this.api.getVariantFeatures(variantId).pipe(takeUntilDestroyed(this.destroyRef)).subscribe(vf => {\n        this.variantFeatures = vf;\n        this.variantFeatures$.next(vf);\n        // Preselect variant features\n        vf.forEach(v => this.selectedFeatureIds.add(v.featureId));\n      });\n      // Populate additional information from derivative when available\n      const byName = (arr, name) => {\n        if (!name) return null;\n        const target = (name || '').toLowerCase();\n        return arr.find(a => (a.name || '').toLowerCase() === target)?.id ?? null;\n      };\n      if (der) {\n        const trId = byName(this.transmissions, der.transmission);\n        const fuId = byName(this.fuelTypes, der.fuelType);\n        const btId = byName(this.bodyTypes, der.bodyType);\n        this.form.patchValue({\n          transmissionId: trId,\n          fuelTypeId: fuId,\n          bodyTypeId: btId\n        }, {\n          emitEvent: false\n        });\n      }\n    });\n    // Derived variants stream (cached)\n    combineLatest([this.generations$.pipe(startWith([])), this.derivatives$.pipe(startWith([])), this.models$.pipe(startWith([])), this.form.get('modelId').valueChanges.pipe(startWith(this.form.value.modelId)), this.form.get('year').valueChanges.pipe(startWith(this.form.value.year)), this.form.get('makeId').valueChanges.pipe(startWith(this.form.value.makeId))]).pipe(map(([generations, derivatives, models, modelId, year, makeId]) => {\n      if (!makeId || !year) return [];\n      const allowedModelIds = new Set(models.map(m => m.id));\n      const gensForYear = generations.filter(g => {\n        const start = g.startYear ?? 0;\n        const end = g.endYear ?? 9999;\n        const inYear = year >= start && year <= end;\n        const inMake = allowedModelIds.has(g.modelId);\n        const matchesModel = !modelId || g.modelId === modelId;\n        return inYear && inMake && matchesModel;\n      });\n      if (gensForYear.length === 0) return [];\n      // Keep imperative fetch for variants by generation; result applied in refreshVariants\n      return [];\n    }), shareReplay(1), takeUntilDestroyed(this.destroyRef)).subscribe();\n  }\n  findById(list, id) {\n    if (id == null) return undefined;\n    return list.find(x => x.id === id);\n  }\n  submit() {\n    if (this.form.invalid || this.saving) return;\n    this.saving = true;\n    this.form.disable({\n      emitEvent: false\n    });\n    const raw = this.form.value;\n    const makeName = this.makes.find(x => x.id === raw.makeId)?.name;\n    const modelName = this.models.find(x => x.id === raw.modelId)?.name;\n    const year = raw.year;\n    const computedTitle = `${makeName ?? ''} ${modelName ?? ''} ${year}`.trim();\n    const derivative = this.derivatives.find(x => x.id === raw.derivativeId);\n    const featureInputs = Array.from(this.selectedFeatureIds).map(id => {\n      const f = this.features.find(x => x.id === id);\n      return {\n        featureCode: f?.code ?? String(id),\n        featureName: f?.name ?? '',\n        featureDescription: f?.description,\n        featureCategoryName: f?.featureCategory ?? '',\n        featureCategoryCode: f?.featureCategoryCode ?? ''\n      };\n    });\n    const dto = {\n      title: computedTitle,\n      description: raw.description ?? undefined,\n      year: raw.year,\n      mileage: raw.mileage,\n      price: raw.price,\n      makeCode: this.makes.find(x => x.id === raw.makeId)?.code,\n      modelCode: this.models.find(x => x.id === raw.modelId)?.code,\n      generationCode: this.generations.find(x => x.id === raw.generationId)?.code,\n      derivativeCode: this.derivatives.find(x => x.id === raw.derivativeId)?.code,\n      variantCode: this.variants.find(x => x.id === raw.variantId)?.code,\n      transmissionTypeCode: raw.transmissionId ? this.transmissions.find(x => x.id === raw.transmissionId)?.code : undefined,\n      fuelTypeCode: raw.fuelTypeId ? this.fuelTypes.find(x => x.id === raw.fuelTypeId)?.code : undefined,\n      bodyTypeCode: this.bodyTypes.find(x => x.id === raw.bodyTypeId)?.code,\n      // Optional labels (snapshots)\n      makeName,\n      modelName,\n      generationName: this.generations.find(x => x.id === raw.generationId)?.name,\n      derivativeName: this.derivatives.find(x => x.id === raw.derivativeId)?.name,\n      variantName: this.variants.find(x => x.id === raw.variantId)?.name,\n      bodyTypeName: this.bodyTypes.find(x => x.id === raw.bodyTypeId)?.name ?? this.derivatives.find(x => x.id === raw.derivativeId)?.bodyType,\n      transmissionTypeName: (raw.transmissionId ? this.transmissions.find(x => x.id === raw.transmissionId)?.name : undefined) ?? this.derivatives.find(x => x.id === raw.derivativeId)?.transmission,\n      fuelTypeName: (raw.fuelTypeId ? this.fuelTypes.find(x => x.id === raw.fuelTypeId)?.name : undefined) ?? this.derivatives.find(x => x.id === raw.derivativeId)?.fuelType,\n      seats: derivative?.seats,\n      doors: derivative?.doors,\n      features: featureInputs\n    };\n    this.api.createListing(dto).subscribe({\n      next: created => {\n        const upload$ = this.selectedFiles.length ? this.api.uploadListingImages(created.id, this.selectedFiles) : undefined;\n        if (upload$) {\n          upload$.pipe(finalize(() => {\n            this.saving = false;\n            this.form.enable({\n              emitEvent: false\n            });\n          })).subscribe({\n            next: () => this.afterCreated(),\n            error: e => {\n              this.saving = false;\n              this.form.enable({\n                emitEvent: false\n              });\n              this.notify.error(typeof e === 'string' ? e : 'Failed to upload images');\n            }\n          });\n        } else {\n          this.saving = false;\n          this.form.enable({\n            emitEvent: false\n          });\n          this.afterCreated();\n        }\n      },\n      error: e => {\n        this.saving = false;\n        this.form.enable({\n          emitEvent: false\n        });\n        this.notify.error(typeof e === 'string' ? e : 'Failed to create listing');\n      }\n    });\n  }\n  // Additional Information: toggle feature selection\n  toggleFeature(featureId, checked) {\n    if (checked) this.selectedFeatureIds.add(featureId);else this.selectedFeatureIds.delete(featureId);\n  }\n  refreshVariants() {\n    const makeId = this.form.value.makeId;\n    const modelId = this.form.value.modelId;\n    const year = this.form.value.year;\n    if (!makeId || !year) return; // Need at least make + year\n    const allowedModelIds = new Set(this.models.map(m => m.id));\n    // Filter generations by year range and by model filter (if a model is chosen)\n    const gensForYear = this.generations.filter(g => {\n      const start = g.startYear ?? 0;\n      const end = g.endYear ?? 9999;\n      const inYear = year >= start && year <= end;\n      const inMake = allowedModelIds.has(g.modelId);\n      const matchesModel = !modelId || g.modelId === modelId;\n      return inYear && inMake && matchesModel;\n    });\n    if (gensForYear.length === 0) {\n      this.variants = [];\n      return;\n    }\n    forkJoin(gensForYear.map(g => this.api.getVariantsByGeneration(g.id))).pipe(map(groups => groups.flat())).subscribe(vars => {\n      const allowedDerivatives = this.derivatives.filter(d => allowedModelIds.has(d.modelId) && (!modelId || d.modelId === modelId));\n      const allowedDerIds = new Set(allowedDerivatives.map(d => d.id));\n      const filtered = vars.filter(v => allowedDerIds.has(v.derivativeId));\n      this.variants = filtered;\n      this.variants$.next(filtered);\n    });\n  }\n  onFilesSelected(ev) {\n    const input = ev.target;\n    const files = input.files;\n    const list = files ? Array.from(files) : [];\n    // Validate: max 10 files, type and size (<=5MB)\n    const maxCount = 10;\n    const maxSize = 5 * 1024 * 1024;\n    const allowed = new Set(['image/jpeg', 'image/png', 'image/webp', 'image/gif']);\n    const filtered = [];\n    for (const f of list) {\n      if (filtered.length >= maxCount) break;\n      if (!allowed.has(f.type)) continue;\n      if (f.size > maxSize) continue;\n      filtered.push(f);\n    }\n    this.selectedFiles = filtered;\n    // Build previews\n    this.previews.forEach(url => URL.revokeObjectURL(url));\n    this.previews = this.selectedFiles.map(f => URL.createObjectURL(f));\n  }\n  afterCreated() {\n    const ref = this.notify.success('Listing created', 'View listings');\n    ref.onAction().subscribe(() => {\n      const el = document.getElementById('listings-section');\n      if (el) el.scrollIntoView({\n        behavior: 'smooth',\n        block: 'start'\n      });\n    });\n    // Reset selected files and previews\n    this.selectedFiles = [];\n    this.previews.forEach(url => URL.revokeObjectURL(url));\n    this.previews = [];\n  }\n  // Drag & drop helpers (UI only)\n  onDragOver(event) {\n    event.preventDefault();\n    this.dragging = true;\n  }\n  onDragLeave(event) {\n    event.preventDefault();\n    this.dragging = false;\n  }\n  onDrop(event) {\n    event.preventDefault();\n    this.dragging = false;\n    const files = event.dataTransfer?.files;\n    if (!files || files.length === 0) return;\n    const inputEvent = {\n      target: {\n        files\n      }\n    };\n    this.onFilesSelected(inputEvent);\n  }\n};\nAddListingComponent = __decorate([Component({\n  selector: 'app-add-listing',\n  standalone: true,\n  imports: [CommonModule, ReactiveFormsModule, ObserversModule, MatFormFieldModule, MatInputModule, MatSelectModule, MatOptionModule, MatButtonModule, MatCardModule, MatProgressSpinnerModule, MatCheckboxModule, MatIconModule, MatTooltipModule, MatDividerModule],\n  templateUrl: './add-listing.component.html',\n  styleUrls: ['./add-listing.component.scss']\n}), __metadata(\"design:paramtypes\", [])], AddListingComponent);\nexport { AddListingComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}